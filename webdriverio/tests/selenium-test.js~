
describe('Integration tests', function () {

    // var mysql = require('mysql');
    // var connection = mysql.createConnection({
    //     host: 'biz_db',
    //     port: '3306'
    //     user: 'root',
    //     password: 'toor'
    // });
    
    // connection.connect(function(err) {
    //     if (err) {
    //         console.error('error connecting: ' + err.stack);
    //         return;
    //     }
 
    //     console.log('connected as id ' + connection.threadId);
    // });
    
    // var webdriver = require('webdriverio')

    var webdriverio = require('webdriverio');
    var options = {
        desiredCapabilities: {
            browserName: 'chrome'
        }
    };
    webdriverio
        .remote(options)
        .init()    
    // var driver = new webdriver.Builder()
    //     .forBrowser('chrome')
    //     .usingServer('http://localhost:8000')
    //     .build();
    
    beforeAll(function(done) {
	jasmine.DEFAULT_TIMEOUT_INTERVAL = 60000;
	
	// DDBB must be cleaned from data, the only thing it should have is the schema.
	done();
    });
    
    afterAll(function(done) {
	webdriverio.end();
	done();
    });

    fdescribe('User.', function () {

	beforeAll(function(done) {
	    // Populate DDBB
	    done();
	});

	afterAll(function(done) {
	    // Depopulate DDBB
	    done();
	});
	
	userNormal = {id: 'patata@mailinator.com',
		      pass: 'test'};

	userProvider = {id: '58d5266e056d1@mailbox92.biz',
			pass: 'test'};

        function waitUntilTitle() {
            webdriverio.waitUntil(function() {
                return webdriverio.getText('head > title') === 'Biz Ecosystem'});
        }
	
	function checkLogin(webdriverio, user, expectedName, done) {
	    waitUntilTitle()
	    // webdriverio.waitUntil(elementLocated(By.linkText('Sign in')));
	    // webdriverio.findElement(By.linkText('Sign in')).click();
            webdriverio.click('body > div.navbar.navbar-default.navbar-fixed-top.z-depth-2 > div > a')
	    // webdriverio.waitUntil(elementLocated(By.id('id_username')));
            webdriverio.waitUntil(function() {
                return webdriverio.getText('#frontpage > div > div.login > div > div > form > div.modal-body.clearfix > div:nth-child(4) > label') === 'Email'
            })
	    // webdriverio.findElement(By.id('id_username')).sendKeys(user.id);
	    // webdriverio.findElement(By.id('id_password')).sendKeys(user.pass);
            webdriverio.setValue('[name=username]', user.id)
            webdriverio.setValue('[name=password]', user.pass)
            webdriverio.click('.btn btn-primary pull-right')
	    // webdriverio.findElement(By.className('btn btn-primary pull-right')).click();
	    waitUntilTitle()
	    // var userLogged = webdriverio.findElement(By.className("hidden-xs ng-binding"));
	    webdriverio.getText('.hidden-xs').then(function(name){
		expect(name).toBe(expectedName);
		done();
	    });
	};

	function createProductSpec(webdriverio, product, expectedProduct, done) {
	    var stringSelector = '/html/body/div[4]/div/div[3]/ui-view/ui-view/ui-view/div/div[2]/div/div/div[2]/div[2]/div[4]/div/ng-include/div[2]/div/form[1]/div[1]/div[2]/div/select/option[1]';
	    var numberSelector = '/html/body/div[4]/div/div[3]/ui-view/ui-view/ui-view/div/div[2]/div/div/div[2]/div[2]/div[4]/div/ng-include/div[2]/div/form[1]/div[1]/div[2]/div/select/option[2]';
	    var numberRangeSelector = '/html/body/div[4]/div/div[3]/ui-view/ui-view/ui-view/div/div[2]/div/div/div[2]/div[2]/div[4]/div/ng-include/div[2]/div/form[1]/div[1]/div[2]/div/select/option[3]';
	    webdriverio.findElement(By.linkText('My stock')).click();
	    webdriverio.findElement(By.className('item-icon fa fa-file')).click();
	    // 1
	    webdriverio.findElement(By.className('btn btn-success')).click();
	    webdriverio.waitUntil(elementLocated(By.name('name')));
	    webdriverio.findElement(By.name('ProductSpecTest')).sendKeys(product.name);
	    webdriverio.findElement(By.name('version')).sendKeys(product.version);
	    webdriverio.findElement(By.name('brand')).sendKeys(product.brand);
	    webdriverio.findElement(By.name('productNumber')).sendKeys(product.productNumber);
	    webdriverio.findElement(By.name('description')).sendKeys(product.description);
	    webdriverio.findElement(By.className('btn btn-default z-depth-1')).click();
	    // 2
	    webdriverio.waitUntil(elementLocated(By.className('track')));
	    webdriverio.findElement(By.className('btn btn-default z-depth-1')).click();
	    // 3
	    webdriverio.waitUntil(elementLocated(By.className('track')));
	    webdriverio.findElement(By.className('btn btn-default z-depth-1')).click();
	    // 4
	    webdriverio.waitUntil(elementLocated(By.className('item-icon fa fa-plus')));
	    if(product.characteristics){
		product.characteristics.forEach(characteristic =>
						webdriverio.findElement(By.className('btn btn-default z-depth-1 ng-scope')).click();
						webdriverio.waitUntil(elementLocated(By.name('name'))).sendKeys(characteristic.name);
						webdriverio.findElement(By.name('description')).sendKeys(characteristic.description);
						// Now i should send the value to the proper field, but first i need to select the correct selector
						if (characteristic.value.type === 'number'){
						    webdriverio.findElement(By.css(numberSelector)).click();
						    webdriverio.findElement(By.name('unitOfMeasure')).sendKeys(characteristic.value.unit);
						    webdriverio.findElement(By.name('value')).sendKeys(characteristic.value.val);
						}else if(characteristic.value.type === 'numberRange'){
						    webdriverio.findElement(By.css(numberRangeSelector)).click();
						    webdriverio.findElement(By.name('valueFrom')).sendKeys(characteristic.value.valFrom);
						    webdriverio.findElement(By.name('valueTo')).sendKeys(characteristic.value.valTo);
						    webdriverio.findElement(By.name('unitOfMeasure')).sendKeys(characteristic.value.unit);
						}else{
						    webdriverio.findElement(By.name('value')).sendKeys(characteristic.value.val);
						}
						webdriverio.findElement(By.className('item-icon fa fa-plus')).click();
					       )
		webdriverio.findElement(By.className('btn btn-warning z-depth-1 ng-scope')).click();
	    }
	    webdriverio.findElement(By.className('btn btn-default z-depth-1')).click();
	    // 5
	    webdriverio.waitUntil(elementLocated(By.className('thumbnail thumbnail-lg')));
	    if (product.picture){
		// Its only a test so we only accept picture URLs
		webdriverio.findElement(By.name('picture')).sendKeys(product.picture)
	    }
	    webdriverio.findElement(By.className('btn btn-default z-depth-1')).click();
	    // 6
	    webdriverio.waitUntil(elementLocated(By.name('type')));
	    webdriverio.findElement(By.className('btn btn-default z-depth-1')).click();
	    // 7
	    webdriverio.waitUntil(elementLocated(By.className('text-muted')));
	    webdriverio.findElement(By.name('title')).sendKeys(product.title);
	    webdriverio.findElement(By.name('text')).sendKeys(product.text);
	    webdriverio.findElement(By.className('btn btn-default z-depth-1')).click();
	    webdriverio.waitUntil(elementLocated(By.name('name')));
	    // TODO: Check that all parameters are the correct ones before creating the product.


	    
	    webdriverio.findElement(By.className('btn btn-warning')).click();
	};
	/*
	  As far as i know, these test must be passed in this order as they emulate user possible actions.
	 */

	// Use this as a placeholder for new tests. Doing all the tests is horrible enough without worrying about what
	// html thing should be checked.
	// // TODO: Change this expect. This checks nothing
	// webdriverio.getTitle().then(function (title) {
	//     expect(title).toBe('Biz Ecosystem');
	// });

	
	
	webdriverio.url('http://logic_proxy:8000/#/offering');
	
	fit('Should be able to log in with a correct username and password', function (done) {
	    checkLogin(webdriverio, userProvider, 'testfiware', done);
	});

	it('Should be able to update his/her info', function(done) {
	    webdriverio.findElement(By.className('dropdown-toggle has-stack')).click();
	    webdriverio.findElement(By.id('Settings')).click();
	    
	    // Change some of the values
	    var fieldName = webdriverio.waitUntil(elementLocated(By.name('firstName')));
	    fieldName.clear();
	    fieldName.sendKeys('testName');
	    webdriverio.findElement(By.name('lastName')).clear();
	    webdriverio.findElement(By.name('lastName')).sendKeys('testSurName');
	    webdriverio.findElement(By.className('btn btn-success')).click();
	    webdriverio.waitUntil(elementLocated(By.className('h4 text-dark-secondary')))
	    var nameInput = webdriverio.waitUntil(elementLocated(By.name('firstName')));
	    nameInput.getAttribute("value").then(function(firstName) {
		expect(firstName).toBe('testName');
		done();
	    })
	});

	it('Should be able to create a new category hierarchy', function(done) {
	    // Go to Admin page
	    webdriverio.findElement(By.className('dropdown-toggle has-stack')).click();
	    webdriverio.findElement(By.id('Admin')).click();
	    // Create a new parent category
	    webdriverio.waitUntil(elementLocated(By.className('btn btn-success')));
	    foundCats = !!webdriverio.findElements(By.linkText('testCategory1'));
	    if (!foundCats) {
	    	webdriverio.findElement(By.className('btn btn-success')).click();
	    	var catName = webdriverio.waitUntil(elementLocated(By.name('name')));
	    	catName.sendKeys('testCategory1');
	    	webdriverio.findElement(By.name('description')).sendKeys('A testing description');
	    	webdriverio.findElement(By.linkText('Next')).click();
	    	webdriverio.waitUntil(elementLocated(By.className('h4 text-dark-secondary')));
	    	webdriverio.findElement(By.className('btn btn-warning')).click();
	    	// TODO: Change this expect. This checks nothing
	    	webdriverio.getTitle().then(function (title) {
	    	    expect(title).toBe('Biz Ecosystem');
		    done();
	    	});
	    }else{
		done();
	    }
	});

	it('Will try to create a new catalog. If the catalog already exists, he should be able to update the status of that catalog', function(done) {
	    webdriverio.findElement(By.className('btn btn-default z-depth-1')).click();
	    webdriverio.waitUntil(titleIs('Biz Ecosystem'));
	    webdriverio.findElement(By.linkText('My stock')).click();
	    var foundCatalog = !!webdriverio.waitUntil(elementLocated(By.linkText('testCata')));
	    if(foundCatalog){
		webdriverio.findElement(By.linkText('testCata')).click();
		webdriverio.findElement(By.className('btn btn-success')).click();
		webdriverio.waitUntil(elementLocated(By.linkText('Home')));		
		// Selenium has a bug where it wont load the second instruction of a goTo("URL"). I dont even know why this work around works. But it does.
		// If Jesus can walk on water. Can he swim on land?
		webdriverio.navigate().to("chrome://version/")
		webdriverio.navigate().to("http://localhost:8000/#/offering")
		
		webdriverio.waitUntil(elementLocated(By.linkText('testCata')));
		foundCatalog = webdriverio.findElement(By.linkText('testCata'));
		foundCatalog.then(x => x.getText().then(function(text) {
			expect(text).toBe('testCatalog23');
			done();
		}));
		// TODO
	    }else{
		webdriverio.findElement(By.className('btn btn-success')).click();
		webdriverio.waitUntil(elementLocated(By.name('name')));
		webdriverio.findElement(By.name('name')).sendKeys('testCatalog21');
		webdriverio.findElement(By.name('description')).sendKeys('A testing description');
		webdriverio.findElement(By.linkText('Next')).click();
		webdriverio.waitUntil(elementLocated(By.className('h4 text-dark-secondary')));
		webdriverio.findElement(By.className('btn btn-warning')).click();	    
		webdriverio.waitUntil(elementLocated(By.className('h4 text-dark-secondary')));
		var catalogName = webdriverio.findElement(By.name("name"));
		catalogName.getAttribute("value").then(function(name){
		    // TODO
		});
		// webdriverio.waitUntil(elementLocated(By.className('status-item status-launched')));
		// expect(name).toBe('testCatalog20');
		// var icon = webdriverio.findElement(By.css("div.status-item.status-launched"));
		// webdriverio
		//     .actions()
		//     .click(icon)
		//     .perform();
		webdriverio.waitUntil(elementLocated(By.className('status-item status-launched active')));
	    }
	});

	xit('Create a new product Specification', function(done) {
	    var product = {};
	    var expectedProduct = {};
	    
	    webdriverio.waitUntil(titleIs('Biz Ecosystem'));
	    // Call the function
	    createProductSpec(webdriverio, product, expectedProduct, done);
	    
	});
    });
});




